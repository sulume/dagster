from typing import Any, Dict, NamedTuple, Optional, Sequence, cast

import dagster.check as check
from dagster.core.definitions.events import AssetKey
from dagster.core.definitions.metadata import MetadataEntry, normalize_metadata
from dagster.core.definitions.partition import PartitionsDefinition


class SourceAsset(
    NamedTuple(
        "_SourceAsset",
        [
            ("key", AssetKey),
            ("metadata_entries", Sequence[MetadataEntry]),
            ("io_manager_key", str),
            ("description", Optional[str]),
            ("partitions", Optional[PartitionsDefinition]),
        ],
    )
):
    """A SourceAsset represents an asset that is not generated by any Dagster op in the repository
    that it's referenced from.

    Attributes:
        key (AssetKey): The key of the asset.
        metadata_entries (List[MetadataEntry]): Metadata associated with the asset.
        io_manager_key (str): The key for the IOManager that will be used to load the contents of
            the asset when it's used as an input to other assets inside a job.
        description (Optional[str]): The description of the asset.
        partitions_def (Optional[PartitionsDefinition]): Defines the set of partition keys that
            compose the asset.
    """

    def __new__(
        cls,
        key: AssetKey,
        metadata: Optional[Dict[str, Any]] = None,
        io_manager_key: str = "io_manager",
        description: Optional[str] = None,
        partitions: Optional[PartitionsDefinition] = None,
    ):

        metadata = check.opt_dict_param(metadata, "metadata", key_type=str)
        metadata_entries = cast(
            Sequence[MetadataEntry],
            check.is_list(normalize_metadata(metadata, [], allow_invalid=True), MetadataEntry),
        )

        return super().__new__(
            cls,
            key=check.inst_param(key, "key", AssetKey),
            metadata_entries=metadata_entries,
            io_manager_key=check.str_param(io_manager_key, "io_manager_key"),
            description=check.opt_str_param(description, "description"),
            partitions=check.opt_inst_param(partitions, "partitions", PartitionsDefinition),
        )

    @property
    def metadata(self) -> Dict[str, Any]:
        return {entry.label: entry.entry_data for entry in self.metadata_entries}
